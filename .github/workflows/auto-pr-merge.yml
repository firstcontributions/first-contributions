name: Auto-merge PRs with Duplicate & Sorting Detection
on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - 'Contributors.md'

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 2
      - name: Check files changed
        id: check_files
        run: |
          PR_FILES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
            jq -r '.[].filename')
          
          FILES_COUNT=$(echo "$PR_FILES" | grep -c ".")
          
          if [[ $FILES_COUNT -eq 1 && "$PR_FILES" == "Contributors.md" ]]; then
            echo "only_contributors=true" >> $GITHUB_OUTPUT
          else
            echo "only_contributors=false" >> $GITHUB_OUTPUT
            echo "files_changed=$PR_FILES" >> $GITHUB_OUTPUT
          fi

      - name: Validate contributor format
        id: validate_format
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            
            const contributorsPath = 'Contributors.md';
            const content = fs.readFileSync(contributorsPath, 'utf8');
            const lines = content.split('\n');
            
            const { data: prFiles } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const diff = prFiles[0].patch;
            const addedLines = diff.split('\n').filter(line => line.startsWith('+') && !line.startsWith('+++'));
            
            let newContributor = '';
            for (const line of addedLines) {
              const contributor = line.substring(1).trim();
              if (contributor && contributor.includes('-') && contributor.includes('@')) {
                newContributor = contributor;
                break;
              }
            }
            
            console.log('New contributor:', newContributor);
            core.setOutput('new_contributor', newContributor);

      - name: Detect duplicates
        id: detect_duplicates
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const newContributor = '${{ steps.validate_format.outputs.new_contributor }}';
            
            const nameMatch = newContributor.match(/^-\s*(.+?)\s*\(@(.+?)\)/);
            if (!nameMatch) {
              core.setOutput('has_duplicates', 'false');
              return;
            }
            
            const [, name, username] = nameMatch;
            const lowerName = name.toLowerCase();
            const lowerUsername = username.toLowerCase();
            
            // Read Contributors.md
            const content = fs.readFileSync('Contributors.md', 'utf8');
            const lines = content.split('\n');
            
            let hasDuplicate = false;
            let duplicateEntry = '';
            
            for (const line of lines) {
              if (line.trim().startsWith('-')) {
                const existingMatch = line.match(/^-\s*(.+?)\s*\(@(.+?)\)/);
                if (existingMatch) {
                  const [, existingName, existingUsername] = existingMatch;
                  
                  // Check both name and username for duplicates
                  if (existingUsername.toLowerCase() === lowerUsername || 
                      existingName.toLowerCase() === lowerName) {
                    hasDuplicate = true;
                    duplicateEntry = line.trim();
                    break;
                  }
                }
              }
            }
            
            core.setOutput('has_duplicates', hasDuplicate ? 'true' : 'false');
            core.setOutput('duplicate_entry', duplicateEntry);

      - name: Check alphabetical sorting
        id: check_sorting
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const newContributor = '${{ steps.validate_format.outputs.new_contributor }}';
            
            const nameMatch = newContributor.match(/^-\s*(.+?)\s*\(@(.+?)\)/);
            if (!nameMatch) {
              core.setOutput('is_sorted', 'false');
              return;
            }
            
            const [, name] = nameMatch;
            const content = fs.readFileSync('Contributors.md', 'utf8');
            const lines = content.split('\n').filter(l => l.trim().startsWith('-'));
            
            // Extract all contributor names
            const names = lines.map(line => {
              const match = line.match(/^-\s*(.+?)\s*\(@/);
              return match ? match[1].toLowerCase() : '';
            }).filter(n => n);
            
            const newNameLower = name.toLowerCase();
            let shouldBeAfter = '';
            let shouldBeBefore = '';
            let isInOrder = true;
            
            for (let i = 0; i < names.length; i++) {
              if (names[i] > newNameLower) {
                shouldBeBefore = names[i];
                if (i > 0) shouldBeAfter = names[i - 1];
                isInOrder = false;
                break;
              }
              shouldBeAfter = names[i];
            }
            
            core.setOutput('is_sorted', isInOrder ? 'true' : 'false');
            core.setOutput('should_after', shouldBeAfter);
            core.setOutput('should_before', shouldBeBefore);

  
      - name: Merge PR
        id: merge_pr
        if: |
          steps.check_files.outputs.only_contributors == 'true' &&
          steps.detect_duplicates.outputs.has_duplicates == 'false' &&
          steps.validate_format.outputs.new_contributor != ''
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const response = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash'
              });
              
              if (response.status === 200) {
                core.setOutput('merge_success', 'true');
              }
            } catch (error) {
              core.setOutput('merge_success', 'false');
              core.setOutput('merge_error', error.message);
            }

      - name: Post success comment
        if: steps.merge_pr.outputs.merge_success == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const celebrationGifs = [
              'https://c.tenor.com/ZCq4SwgCfxAAAAAC/snoopy-peanuts.gif',
              'https://c.tenor.com/Z0ojZS2kpO0AAAAC/milk-and-mocha-happy.gif',
              'https://c.tenor.com/LffD4a8ET9AAAAAC/heart-celebrate.gif',
              'https://c.tenor.com/HJ0iSKwIG28AAAAC/yes-baby.gif',
              'https://c.tenor.com/4blWuIh5MIYAAAAC/baby-yoda.gif',
              'https://c.tenor.com/B_zYdea4l-4AAAAC/yay-minions.gif',
              'https://media1.giphy.com/media/artj92V8o75VPL7AeQ/giphy.gif',
              'https://media2.giphy.com/media/IwAZ6dvvvaTtdI8SD5/giphy.gif',
            ];
            
            const getRandomGif = () => celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];
            const username = context.payload.pull_request.user.login;
            const newContributor = '${{ steps.validate_format.outputs.new_contributor }}';
            
            const successMessage = `
 **Congratulations @${username}!** ðŸŽ‰

Your contribution has been successfully merged! 

 **Validation passed:**
- âœ“ Correct format
- âœ“ No duplicates found
- âœ“ Alphabetically sorted

**Your entry:** ${newContributor}

---


Thanks for being part of our community! 

![celebration](${getRandomGif()})
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: successMessage
            });

      - name: Post duplicate error comment
        if: steps.detect_duplicates.outputs.has_duplicates == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const username = context.payload.pull_request.user.login;
            const duplicateEntry = '${{ steps.detect_duplicates.outputs.duplicate_entry }}';
            
            const duplicateMessage = `
 **Duplicate Entry Detected** @${username}

Your contribution couldn't be merged because **this contributor already exists** in our list:

**Existing entry:**
\`\`\`
${duplicateEntry}
\`\`\`

---

1. Check if you accidentally added yourself twice
2. If this is a different person, use a different name or GitHub username
3. Close this PR and open a new one with the corrected entry

**Questions?** Feel free to ask! We're here to help. ðŸ˜Š
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: duplicateMessage
            });

      - name: Post sorting error comment
        if: |
          steps.check_files.outputs.only_contributors == 'true' &&
          steps.detect_duplicates.outputs.has_duplicates == 'false' &&
          steps.check_sorting.outputs.is_sorted == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const username = context.payload.pull_request.user.login;
            const newContributor = '${{ steps.validate_format.outputs.new_contributor }}';
            const shouldAfter = '${{ steps.check_sorting.outputs.should_after }}';
            const shouldBefore = '${{ steps.check_sorting.outputs.should_before }}';
            
            const sortingMessage = `
ðŸ”¤ **Sorting Issue** @${username}

Thanks for your contribution! However, the contributors list must be **sorted alphabetically** to keep things organized.

**Your entry:** ${newContributor}

**Should be placed between:**
- After: ${shouldAfter || 'Start of list'}
- Before: ${shouldBefore || 'End of list'}

---

1. Edit \`Contributors.md\` in your fork
2. Move your entry to the correct alphabetical position
3. Commit and push the changes
4. The PR will auto-merge once it's in the right place 

**Questions?** Feel free to ask! We're here to help. 
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: sortingMessage
            });

      - name: Post files changed comment
        if: steps.check_files.outputs.only_contributors == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const username = context.payload.pull_request.user.login;
            const filesChanged = `${{ steps.check_files.outputs.files_changed }}`;
            
            const filesMessage = `
 **Multiple Files Changed** @${username}

This PR can only merge changes to \`Contributors.md\` file. However, the following files were modified:

\`\`\`
${filesChanged.trim().split('\n').map(f => '- ' + f).join('\n')}
\`\`\`

---

1. Close this PR
2. Create a new branch with **only** changes to \`Contributors.md\`
3. Revert other file changes if needed
4. Open a new PR with only the contributor entry

**Questions?** Feel free to ask! We're here to help. 
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: filesMessage
            });

      - name: Post format error comment
        if: |
          steps.check_files.outputs.only_contributors == 'true' &&
          steps.validate_format.outputs.new_contributor == ''
        uses: actions/github-script@v6
        with:
          script: |
            const username = context.payload.pull_request.user.login;
            
            const formatMessage = `
 **Invalid Format** @${username}

Your contribution couldn't be merged because the format is incorrect.

---

\`\`\`
- Your Full Name (@your_github_username)
\`\`\`

**Examples:**
- Alice Johnson (@alice_dev)
- Bob Smith (@bob_coder)
- Carol Williams (@carol_engineer)

---

1. Edit your entry to match the format above
2. Make sure there's a dash (\`-\`), name, and GitHub username
3. Commit and push the changes
4. The PR will auto-merge once the format is correct 

**Questions?** Feel free to ask! We're here to help. 
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: formatMessage
            });
